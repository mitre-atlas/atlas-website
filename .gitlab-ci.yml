image: node:latest

variables:
  GIT_SUBMODULE_STRATEGY: recursive

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - .npm/

default:
  before_script:
    # Install and cache dependencies
    - npm install --cache .npm --prefer-offline

pages:
  stage: test
  script:
    # Set the base url
    - yarn run build --base=$CI_PAGES_URL
    # Configure to set Navigator URL, etc.
    - echo "NAVIGATOR_URL=https://mitre-atlas.github.io/atlas-navigator" > .env
    # Increase available heap space for npm run generate
    - export NODE_OPTIONS="--max_old_space_size=8192"
    # Generate static files
    - npm run build
    # Make static files available to GitLab Pages
    - mv dist public
    
  artifacts:
    paths:
      - public
  tags:
    - pages
  only:
    - develop

# # Functions that should be executed before the build script is run
# before_script:
#   # Install Dependencies
#   - npm install
# pages:
#   script:
#     # Build site files
#     - npm run build
#     # Make files available to GitLab Pages
#     - mv dist public
#   stage: test
#   artifacts:
#     paths:
#       # The folder that contains the files to be exposed at the Page URL
#       - public
#   rules:
#     # This ensures that only pushes to the default branch will trigger
#     # a pages deploy
#     - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
#   tags:
#   - pages

